# 联邦元学习改进说明

## 📋 快速总结

**改动文件**: `DemoModelTraining.py`（在原文件基础上改进）  
**改动量**: 新增~100行，保留原代码95%  
**核心改动**: 仅预训练循环（联邦梯度平均）  
**元学习算法**: 100%保留（Support/Query/Few-shot）

---

## 🎯 一键开关

```python
# DemoModelTraining.py 第12行
USE_FEDERATION = True   # 联邦模式（3场站，推荐⭐）
USE_FEDERATION = False  # 单场站模式（原方法）
```

---

## 📝 改动清单（3处）

### 1. 联邦开关（第12行）
```python
USE_FEDERATION = True  # [新增]
```

### 2. 多场站数据加载（第38-194行）
```python
# [新增] 循环加载3个场站
station_ids = ['58', '59', '60'] if USE_FEDERATION else ['58']
for station_id in station_ids:
    station_data[station_id] = scio.loadmat(f'{station_id}wf_4_train')
    clients_train_data[station_id] = {...}  # 准备客户端数据
```

### 3. 联邦梯度平均（第308-368行）⭐核心
```python
if USE_FEDERATION:
    # [核心改动] 联邦梯度累积
    for station_id in ['58','59','60']:
        loss = compute_loss(station_id)
        (loss / 3).backward()  # 累积梯度
    optimizer.step()  # 统一更新
else:
    # [原代码] 单场站逻辑
    loss.backward()
    optimizer.step()
```

**核心公式**：
```
单场站: θ = θ - α∇L₅₈
联邦:   θ = θ - α(∇L₅₈+∇L₅₉+∇L₆₀)/3
```

---

## 🔒 完全保留的部分（95%）

✅ 模型结构（TCN, LWP）  
✅ Loss函数（MSE + Penalty）  
✅ **元训练阶段**（Support/Query，第370-450行）  
✅ **Few-shot测试**（第460-510行）  
✅ 参数冻结策略

**元学习算法100%保留！**

---

## 📊 效果对比

| 项目 | 单场站 | 联邦 | 提升 |
|------|--------|------|------|
| 数据量 | 16,550 | 49,975 | +202% |
| 场站数 | 1个 | 3个 | +200% |
| 任务类型 | 聚类伪任务 | 真实场站 | ✓ |
| 泛化能力 | 单地理位置 | 多地理位置 | ✓ |

---

## 🚀 使用方法

### 联邦训练（推荐）
```bash
# 1. 确认第12行: USE_FEDERATION = True
# 2. 运行
screen -S wpf_fed
python DemoModelTraining.py

# 3. 生成结果
python generate_predictions_csv.py
```

**输出**：
- `model_fore_pre_federated.pth` - 联邦预训练模型
- `model_fore_train_task_*.pth` - 元训练模型
- `test_predictions.csv` - 测试结果
- `model_performance_metrics.csv` - 性能指标

---

### 单场站训练（对比）
```bash
# 1. 修改第12行: USE_FEDERATION = False  
# 2. 运行
python DemoModelTraining.py
python generate_predictions_csv.py
```

---

## 📈 结果格式

### CSV文件（百分比格式）
```csv
Model,MAE_%,RMSE_%,MAPE_%,R2_Score
Extreme_Weather_Model_1,2.50,3.20,8.50,0.92
```

**说明**：
- MAE/RMSE：标幺值×100（%）
- MAPE：排除<5%功率样本
- 数据同时包含标幺值(_pu)和MW值(_MW)

---

## 💡 核心技术

### 联邦平均机制
```python
# 遍历客户端，累积梯度
for client in clients:
    loss = f(client_data)
    (loss / num_clients).backward()  # 关键：除以客户端数

# 统一更新（包含所有客户端的平均梯度）
optimizer.step()
```

### 与元学习的结合
- **预训练**：联邦方式（多场站梯度平均）
- **元训练**：原方法（Support/Query）
- **测试**：原方法（Few-shot适应）

---

## ✅ 验证通过

- ✓ 联邦模式：3场站加载成功（49,975样本）
- ✓ 单场站模式：向后兼容（16,550样本）
- ✓ 代码注释：清晰标注改动点
- ✓ 一键切换：USE_FEDERATION开关

---

## 🎓 理解要点

### 改动最少
**只改预训练循环**，其他95%代码不变

### 算法保留
**元学习算法100%保留**，联邦只是叠加功能

### 效果叠加
```
联邦版 = 原元学习算法 + 多场站数据 + 联邦平均
```

---

**立即可用！** 修改第12行开关即可运行。

更新时间: 2026-02-28
